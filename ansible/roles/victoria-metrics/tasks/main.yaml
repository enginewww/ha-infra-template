- name: Install dependencies
  ansible.builtin.package:
    name:
      - wget
      - ca-certificates
    state: present
    update_cache: yes

- name: Create VictoriaMetrics directory
  ansible.builtin.file:
    path: "{{ vm_dir }}"
    state: directory
    mode: '0755'

- name: Download VictoriaMetrics tarball
  ansible.builtin.get_url:
    url: "https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v{{ vm_version }}/victoria-metrics-linux-amd64-v{{ vm_version }}.tar.gz"
    dest: "{{ vm_dir }}/victoria-metrics.tar.gz"
    mode: '0644'

- name: Extract VictoriaMetrics
  ansible.builtin.unarchive:
    src: "{{ vm_dir }}/victoria-metrics.tar.gz"
    dest: "{{ vm_dir }}"
    remote_src: yes
    creates: "{{ vm_dir }}/victoria-metrics-prod"

- name: Ensure VictoriaMetrics data directory exists
  ansible.builtin.file:
    path: "{{ vm_dir }}/data"
    state: directory
    mode: '0755'

- name: Render scrape config
  ansible.builtin.template:
    src: scrape.yml.j2
    dest: "{{ vm_scrape_config }}"
    mode: '0644'

- name: Start VictoriaMetrics 
  ansible.builtin.shell: |
    {{ vm_dir }}/victoria-metrics-prod \
      -storageDataPath={{ vm_dir }}/data \
      -promscrape.config={{ vm_scrape_config }} \
      > {{ vm_dir }}/vm.log 2>&1 &
  args:
    executable: /bin/bash