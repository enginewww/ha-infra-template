- name: Verify keepalived_exporter is listening
  block:
    - name: Wait for exporter port
      ansible.builtin.wait_for:
        port: "{{ keepalived_exporter_port }}"
        timeout: 5
  rescue:
    - name: Print last 20 lines of keepalived_exporter log if port failed
      ansible.builtin.shell: "tail -n 20 {{ keepalived_exporter_dir }}/keepalived_exporter.log"
      register: exporter_log
      ignore_errors: true

    - name: Fail playbook with log snippet
      ansible.builtin.fail:
        msg: |
          keepalived_exporter did not start or port {{ keepalived_exporter_port }} not open.
          Last lines of log:
          {{ exporter_log.stdout_lines | join('\n') }}